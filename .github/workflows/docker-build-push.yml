name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Log in to private registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push images using docker-compose
        run: |
          # Get list of services from docker-compose.yml
          services=$(docker-compose config --services)
          echo "Services found: $services"

          # Build each service
          for service in $services; do
            echo "Building service: $service"
            docker-compose build $service

            # Get the image name from docker-compose
            image_name=$(docker-compose images | grep "$service" | awk '{print $2}')
            if [ -z "$image_name" ]; then
              # Fallback: if image name not found, use a default pattern
              image_name="firecrawl_$service"
            fi

            # Tag and push
            new_tag="${{ secrets.REGISTRY_URL }}/firecrawl-$service:latest"
            echo "Tagging $image_name to $new_tag"
            docker tag "$image_name" "$new_tag"
            docker push "$new_tag"
          done
